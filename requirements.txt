import streamlit as st
import pandas as pd
import requests
import altair as alt

# ===== CONFIGURACI√ìN =====
CHANNEL_ID = TU_CHANNEL_ID  # Reemplaza con tu canal
READ_API_KEY = TU_READ_API_KEY  # Si el canal es privado
N_RESULTS = 100  # n√∫mero de muestras a leer

# ===== FUNCI√ìN PARA DESCARGAR DATOS =====
def get_data()
    url = fhttpsapi.thingspeak.comchannels{CHANNEL_ID}feeds.jsonresults={N_RESULTS}
    if READ_API_KEY
        url += f&api_key={READ_API_KEY}
    r = requests.get(url)
    if r.status_code == 200
        data = r.json()[feeds]
        df = pd.DataFrame(data)
        df[created_at] = pd.to_datetime(df[created_at])
        # convierte a num√©rico los fields
        for i in range(1, 8)
            if ffield{i} in df.columns
                df[ffield{i}] = pd.to_numeric(df[ffield{i}], errors=coerce)
        return df
    else
        st.error(‚ùå Error al obtener datos de ThingSpeak)
        return pd.DataFrame()

# ===== STREAMLIT APP =====
st.title(üìä Dashboard IoT con ThingSpeak + Streamlit)
st.write(Visualizaci√≥n en tiempo real de los datos enviados desde el ESP32)

df = get_data()

if not df.empty
    st.subheader(Datos recientes)
    st.write(df.tail(5))  # muestra las √∫ltimas filas
    
    # Gr√°ficas
    st.subheader(üìà Temperatura y Humedad)
    chart1 = alt.Chart(df).mark_line().encode(
        x=created_atT,
        y=field1Q,
        tooltip=[created_at, field1]
    ).properties(title=Temperatura (¬∞C))
    chart2 = alt.Chart(df).mark_line(color=green).encode(
        x=created_atT,
        y=field2Q,
        tooltip=[created_at, field2]
    ).properties(title=Humedad (%))
    st.altair_chart(chart1, use_container_width=True)
    st.altair_chart(chart2, use_container_width=True)

    st.subheader(‚ö° Energ√≠a El√©ctrica)
    chart3 = alt.Chart(df).mark_line(color=orange).encode(
        x=created_atT,
        y=field4Q,
        tooltip=[created_at, field4]
    ).properties(title=Voltaje (V))
    chart4 = alt.Chart(df).mark_line(color=red).encode(
        x=created_atT,
        y=field5Q,
        tooltip=[created_at, field5]
    ).properties(title=Corriente (A))
    chart5 = alt.Chart(df).mark_line(color=purple).encode(
        x=created_atT,
        y=field6Q,
        tooltip=[created_at, field6]
    ).properties(title=Potencia (W))
    chart6 = alt.Chart(df).mark_line(color=blue).encode(
        x=created_atT,
        y=field7Q,
        tooltip=[created_at, field7]
    ).properties(title=Energ√≠a (kWh))
    
    st.altair_chart(chart3, use_container_width=True)
    st.altair_chart(chart4, use_container_width=True)
    st.altair_chart(chart5, use_container_width=True)
    st.altair_chart(chart6, use_container_width=True)

else
    st.warning(‚ö† No se pudieron cargar los datos a√∫n.)
